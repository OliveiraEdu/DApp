import os
import binascii
import csv
from iroha import IrohaCrypto
from iroha import Iroha, IrohaGrpc
import sys
from Crypto.Hash import keccak
import integration_helpers
from name_generator import left, right
import random

if sys.version_info[0] < 3:
    raise Exception("Python 3 or a more recent version is required.")

# Here is the information about the environment and admin account information:
IROHA_HOST_ADDR = os.getenv("IROHA_HOST_ADDR", "127.0.0.1")
IROHA_PORT = os.getenv("IROHA_PORT", "50051")
ADMIN_ACCOUNT_ID = os.getenv("ADMIN_ACCOUNT_ID", "admin@test")
ADMIN_PRIVATE_KEY = os.getenv(
    "ADMIN_PRIVATE_KEY",
    "f101537e319568c765b2cc89698325604991dca57b9716b58016b253506cab70",
)

iroha = Iroha(ADMIN_ACCOUNT_ID)
net = IrohaGrpc("{}:{}".format(IROHA_HOST_ADDR, IROHA_PORT))

user_private_key = IrohaCrypto.private_key()
user_public_key = IrohaCrypto.derive_public_key(user_private_key).decode("utf-8")

DOMAIN = "test"

user_account_left = random.choice(left)
user_account_right = random.choice(right)
user_account_short_id = f"{user_account_left}_{user_account_right}"
print(f"Creating account with name: {user_account_short_id}")

def dump_to_csv(account_id, private_key, public_key, filename="accounts.csv"):
    file_exists = os.path.isfile(filename)
    with open(filename, mode='a', newline='') as file:
        writer = csv.writer(file)
        if not file_exists:
            writer.writerow(["Account ID", "Private Key", "Public Key"])
        writer.writerow([account_id, private_key, public_key])

@integration_helpers.trace
def create_contract():
    bytecode = "6080604052348015600e575f80fd5b5073a6abc17819738299b3b2c1ce46d55c74f04e290c5f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061112b8061006f5f395ff3fe608060405234801561000f575f80fd5b5060043610610055575f3560e01c8063399da1f3146100595780635bdb3a41146100895780637949a1b3146100a7578063b7d66df7146100d7578063d4e804ab14610107575b5f80fd5b610073600480360381019061006e9190610a6d565b610125565b6040516100809190610b71565b60405180910390f35b61009161037f565b60405161009e9190610b71565b60405180910390f35b6100c160048036038101906100bc9190610b91565b6104d8565b6040516100ce9190610b71565b60405180910390f35b6100f160048036038101906100ec9190610c07565b610641565b6040516100fe9190610b71565b60405180910390f35b61010f61081b565b60405161011c9190610cea565b60405180910390f35b6060815183511461016b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161016290610d83565b60405180910390fd5b5f5b8351811015610317575f8585838151811061018b5761018a610da1565b5b60200260200101518584815181106101a6576101a5610da1565b5b60200260200101516040516024016101c093929190610e10565b6040516020818303038152906040527fb7d66df7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f805f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16836040516102859190610e94565b5f60405180830381855af49150503d805f81146102bd576040519150601f19603f3d011682016040523d82523d5f602084013e6102c2565b606091505b509150915081610307576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102fe90610f1a565b60405180910390fd5b505050808060010191505061016d565b50836040516103269190610f72565b60405180910390207fedbd1a1a82a4dd2b4fd3f01d33523aec08a88903c37a2af0038c83429fec5c91848460405161035f92919061108b565b60405180910390a260405180602001604052805f81525090509392505050565b60605f6040516024016040516020818303038152906040527f5bdb3a41000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f805f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168360405161044d9190610e94565b5f60405180830381855af49150503d805f8114610485576040519150601f19603f3d011682016040523d82523d5f602084013e61048a565b606091505b5091509150816104cf576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104c690610f1a565b60405180910390fd5b80935050505090565b60605f83836040516024016104ee9291906110c0565b6040516020818303038152906040527f7949a1b3000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f805f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16836040516105b39190610e94565b5f60405180830381855af49150503d805f81146105eb576040519150601f19603f3d011682016040523d82523d5f602084013e6105f0565b606091505b509150915081610635576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161062c90610f1a565b60405180910390fd5b80935050505092915050565b60605f84848460405160240161065993929190610e10565b6040516020818303038152906040527fb7d66df7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f805f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168360405161071e9190610e94565b5f60405180830381855af49150503d805f8114610756576040519150601f19603f3d011682016040523d82523d5f602084013e61075b565b606091505b5091509150816107a0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161079790610f1a565b60405180910390fd5b846040516107ae9190610f72565b6040518091039020866040516107c49190610f72565b6040518091039020886040516107da9190610f72565b60405180910390207f5e1b38cd47cf21b75d5051af29fa321eedd94877db5ac62067a076770eddc9d060405160405180910390a48093505050509392505050565b5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b61089d82610857565b810181811067ffffffffffffffff821117156108bc576108bb610867565b5b80604052505050565b5f6108ce61083e565b90506108da8282610894565b919050565b5f67ffffffffffffffff8211156108f9576108f8610867565b5b61090282610857565b9050602081019050919050565b828183375f83830152505050565b5f61092f61092a846108df565b6108c5565b90508281526020810184848401111561094b5761094a610853565b5b61095684828561090f565b509392505050565b5f82601f8301126109725761097161084f565b5b813561098284826020860161091d565b91505092915050565b5f67ffffffffffffffff8211156109a5576109a4610867565b5b602082029050602081019050919050565b5f80fd5b5f6109cc6109c78461098b565b6108c5565b905080838252602082019050602084028301858111156109ef576109ee6109b6565b5b835b81811015610a3657803567ffffffffffffffff811115610a1457610a1361084f565b5b808601610a21898261095e565b855260208501945050506020810190506109f1565b5050509392505050565b5f82601f830112610a5457610a5361084f565b5b8135610a648482602086016109ba565b91505092915050565b5f805f60608486031215610a8457610a83610847565b5b5f84013567ffffffffffffffff811115610aa157610aa061084b565b5b610aad8682870161095e565b935050602084013567ffffffffffffffff811115610ace57610acd61084b565b5b610ada86828701610a40565b925050604084013567ffffffffffffffff811115610afb57610afa61084b565b5b610b0786828701610a40565b9150509250925092565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f610b4382610b11565b610b4d8185610b1b565b9350610b5d818560208601610b2b565b610b6681610857565b840191505092915050565b5f6020820190508181035f830152610b898184610b39565b905092915050565b5f8060408385031215610ba757610ba6610847565b5b5f83013567ffffffffffffffff811115610bc457610bc361084b565b5b610bd08582860161095e565b925050602083013567ffffffffffffffff811115610bf157610bf061084b565b5b610bfd8582860161095e565b9150509250929050565b5f805f60608486031215610c1e57610c1d610847565b5b5f84013567ffffffffffffffff811115610c3b57610c3a61084b565b5b610c478682870161095e565b935050602084013567ffffffffffffffff811115610c6857610c6761084b565b5b610c748682870161095e565b925050604084013567ffffffffffffffff811115610c9557610c9461084b565b5b610ca18682870161095e565b9150509250925092565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610cd482610cab565b9050919050565b610ce481610cca565b82525050565b5f602082019050610cfd5f830184610cdb565b92915050565b5f82825260208201905092915050565b7f4b65797320616e642076616c756573206172726179206c656e677468206d75735f8201527f74206d6174636800000000000000000000000000000000000000000000000000602082015250565b5f610d6d602783610d03565b9150610d7882610d13565b604082019050919050565b5f6020820190508181035f830152610d9a81610d61565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f81519050919050565b5f610de282610dce565b610dec8185610d03565b9350610dfc818560208601610b2b565b610e0581610857565b840191505092915050565b5f6060820190508181035f830152610e288186610dd8565b90508181036020830152610e3c8185610dd8565b90508181036040830152610e508184610dd8565b9050949350505050565b5f81905092915050565b5f610e6e82610b11565b610e788185610e5a565b9350610e88818560208601610b2b565b80840191505092915050565b5f610e9f8284610e64565b915081905092915050565b7f4572726f722063616c6c696e67207365727669636520636f6e747261637420665f8201527f756e6374696f6e00000000000000000000000000000000000000000000000000602082015250565b5f610f04602783610d03565b9150610f0f82610eaa565b604082019050919050565b5f6020820190508181035f830152610f3181610ef8565b9050919050565b5f81905092915050565b5f610f4c82610dce565b610f568185610f38565b9350610f66818560208601610b2b565b80840191505092915050565b5f610f7d8284610f42565b915081905092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f82825260208201905092915050565b5f610fcb82610dce565b610fd58185610fb1565b9350610fe5818560208601610b2b565b610fee81610857565b840191505092915050565b5f6110048383610fc1565b905092915050565b5f602082019050919050565b5f61102282610f88565b61102c8185610f92565b93508360208202850161103e85610fa2565b805f5b85811015611079578484038952815161105a8582610ff9565b94506110658361100c565b925060208a01995050600181019050611041565b50829750879550505050505092915050565b5f6040820190508181035f8301526110a38185611018565b905081810360208301526110b78184611018565b90509392505050565b5f6040820190508181035f8301526110d88185610dd8565b905081810360208301526110ec8184610dd8565b9050939250505056fea26469706673582212206200e0a6b1304cd9248218170a5127d226fed76882fe47a014f6956b8e22d19164736f6c634300081a0033"
    """Bytecode was generated using remix editor  https://remix.ethereum.org/ from file account.sol. """
    tx = iroha.transaction(
        [iroha.command("CallEngine", caller=ADMIN_ACCOUNT_ID, input=bytecode)]
    )
    IrohaCrypto.sign_transaction(tx, ADMIN_PRIVATE_KEY)
    net.send_tx(tx)
    hex_hash = binascii.hexlify(IrohaCrypto.hash(tx))
    for status in net.tx_status_stream(tx):
        print(status)
    return hex_hash

@integration_helpers.trace
def create_account(address):
    params = integration_helpers.get_first_four_bytes_of_keccak(
        b"createAccount(string,string,string)"
    )
    no_of_param = 3
    for x in range(no_of_param):
        params = params + integration_helpers.left_padded_address_of_param(
            x, no_of_param
        )
    params = params + integration_helpers.argument_encoding(user_account_short_id)  # source account id
    params = params + integration_helpers.argument_encoding(DOMAIN)  # domain id
    params = params + integration_helpers.argument_encoding(user_public_key)  #  key
    tx = iroha.transaction(
        [
            iroha.command(
                "CallEngine", caller=ADMIN_ACCOUNT_ID, callee=address, input=params
            )
        ]
    )
    IrohaCrypto.sign_transaction(tx, ADMIN_PRIVATE_KEY)
    response = net.send_tx(tx)
    for status in net.tx_status_stream(tx):
        print(status)
    hex_hash = binascii.hexlify(IrohaCrypto.hash(tx))
    dump_to_csv(f"{user_account_short_id}@{DOMAIN}", user_private_key, user_public_key)
    return hex_hash

@integration_helpers.trace
def get_account(address):
    params = integration_helpers.get_first_four_bytes_of_keccak(b"getAccount(string)")
    no_of_param = 1
    for x in range(no_of_param):
        params = params + integration_helpers.left_padded_address_of_param(
            x, no_of_param
        )
    params = params + integration_helpers.argument_encoding(f"{user_account_short_id}@{DOMAIN}")  # account id
    tx = iroha.transaction(
        [
            iroha.command(
                "CallEngine", caller=ADMIN_ACCOUNT_ID, callee=address, input=params
            )
        ]
    )
    IrohaCrypto.sign_transaction(tx, ADMIN_PRIVATE_KEY)
    response = net.send_tx(tx)
    for status in net.tx_status_stream(tx):
        print(status)
    hex_hash = binascii.hexlify(IrohaCrypto.hash(tx))
    return hex_hash

hash = create_contract()
address = integration_helpers.get_engine_receipts_address(hash)
create_account(address)
hash = get_account(address)
integration_helpers.get_engine_receipts_result(hash)
print("done")
