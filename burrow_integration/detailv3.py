from Crypto.Hash import keccak
import os
import binascii
import csv
from iroha import IrohaCrypto
from iroha import Iroha, IrohaGrpc
from iroha.ed25519 import H
import integration_helpers
from iroha.primitive_pb2 import can_set_my_account_detail
import sys

if sys.version_info[0] < 3:
    raise Exception("Python 3 or a more recent version is required.")

IROHA_HOST_ADDR = os.getenv("IROHA_HOST_ADDR", "127.0.0.1")
IROHA_PORT = os.getenv("IROHA_PORT", "50051")
ADMIN_ACCOUNT_ID = os.getenv("ADMIN_ACCOUNT_ID", "admin@test")
ADMIN_PRIVATE_KEY = os.getenv(
    "ADMIN_PRIVATE_KEY",
    "f101537e319568c765b2cc89698325604991dca57b9716b58016b253506cab70",
)

user_private_key = IrohaCrypto.private_key()
user_public_key = IrohaCrypto.derive_public_key(user_private_key)
iroha = Iroha(ADMIN_ACCOUNT_ID)
net = IrohaGrpc("{}:{}".format(IROHA_HOST_ADDR, IROHA_PORT))

def read_accounts_from_csv(file_path):
    accounts = []
    with open(file_path, mode='r') as file:
        csv_reader = csv.DictReader(file)
        for row in csv_reader:
            accounts.append({
                'account_id': row['Account ID'],
                'private_key': row['Private Key'],
                'public_key': row['Public Key']
            })
    return accounts


@integration_helpers.trace
def create_contract():
    bytecode = "6080604052348015600e575f80fd5b5073a6abc17819738299b3b2c1ce46d55c74f04e290c5f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061113b8061006f5f395ff3fe608060405234801561000f575f80fd5b5060043610610055575f3560e01c8063399da1f3146100595780635bdb3a41146100895780637949a1b3146100a7578063b7d66df7146100d7578063d4e804ab14610107575b5f80fd5b610073600480360381019061006e9190610a4a565b610125565b6040516100809190610b08565b60405180910390f35b61009161036a565b60405161009e9190610b81565b60405180910390f35b6100c160048036038101906100bc9190610ba1565b6104c3565b6040516100ce9190610b08565b60405180910390f35b6100f160048036038101906100ec9190610c17565b610625565b6040516100fe9190610b08565b60405180910390f35b61010f6107f8565b60405161011c9190610cfa565b60405180910390f35b5f815183511461016a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161016190610d93565b60405180910390fd5b5f5b8351811015610313575f8585838151811061018a57610189610db1565b5b60200260200101518584815181106101a5576101a4610db1565b5b60200260200101516040516024016101bf93929190610e20565b6040516020818303038152906040527fb7d66df7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16816040516102829190610ea4565b5f60405180830381855af49150503d805f81146102ba576040519150601f19603f3d011682016040523d82523d5f602084013e6102bf565b606091505b50508093505082610305576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102fc90610f2a565b60405180910390fd5b50808060010191505061016c565b50836040516103229190610f82565b60405180910390207fedbd1a1a82a4dd2b4fd3f01d33523aec08a88903c37a2af0038c83429fec5c91848460405161035b92919061109b565b60405180910390a29392505050565b60605f6040516024016040516020818303038152906040527f5bdb3a41000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f805f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16836040516104389190610ea4565b5f60405180830381855af49150503d805f8114610470576040519150601f19603f3d011682016040523d82523d5f602084013e610475565b606091505b5091509150816104ba576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104b190610f2a565b60405180910390fd5b80935050505090565b5f8083836040516024016104d89291906110d0565b6040516020818303038152906040527f7949a1b3000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168160405161059b9190610ea4565b5f60405180830381855af49150503d805f81146105d3576040519150601f19603f3d011682016040523d82523d5f602084013e6105d8565b606091505b5050809250508161061e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161061590610f2a565b60405180910390fd5b5092915050565b5f8084848460405160240161063c93929190610e20565b6040516020818303038152906040527fb7d66df7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16816040516106ff9190610ea4565b5f60405180830381855af49150503d805f8114610737576040519150601f19603f3d011682016040523d82523d5f602084013e61073c565b606091505b50508092505081610782576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161077990610f2a565b60405180910390fd5b826040516107909190610f82565b6040518091039020846040516107a69190610f82565b6040518091039020866040516107bc9190610f82565b60405180910390207f5e1b38cd47cf21b75d5051af29fa321eedd94877db5ac62067a076770eddc9d060405160405180910390a4509392505050565b5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b61087a82610834565b810181811067ffffffffffffffff8211171561089957610898610844565b5b80604052505050565b5f6108ab61081b565b90506108b78282610871565b919050565b5f67ffffffffffffffff8211156108d6576108d5610844565b5b6108df82610834565b9050602081019050919050565b828183375f83830152505050565b5f61090c610907846108bc565b6108a2565b90508281526020810184848401111561092857610927610830565b5b6109338482856108ec565b509392505050565b5f82601f83011261094f5761094e61082c565b5b813561095f8482602086016108fa565b91505092915050565b5f67ffffffffffffffff82111561098257610981610844565b5b602082029050602081019050919050565b5f80fd5b5f6109a96109a484610968565b6108a2565b905080838252602082019050602084028301858111156109cc576109cb610993565b5b835b81811015610a1357803567ffffffffffffffff8111156109f1576109f061082c565b5b8086016109fe898261093b565b855260208501945050506020810190506109ce565b5050509392505050565b5f82601f830112610a3157610a3061082c565b5b8135610a41848260208601610997565b91505092915050565b5f805f60608486031215610a6157610a60610824565b5b5f84013567ffffffffffffffff811115610a7e57610a7d610828565b5b610a8a8682870161093b565b935050602084013567ffffffffffffffff811115610aab57610aaa610828565b5b610ab786828701610a1d565b925050604084013567ffffffffffffffff811115610ad857610ad7610828565b5b610ae486828701610a1d565b9150509250925092565b5f8115159050919050565b610b0281610aee565b82525050565b5f602082019050610b1b5f830184610af9565b92915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f610b5382610b21565b610b5d8185610b2b565b9350610b6d818560208601610b3b565b610b7681610834565b840191505092915050565b5f6020820190508181035f830152610b998184610b49565b905092915050565b5f8060408385031215610bb757610bb6610824565b5b5f83013567ffffffffffffffff811115610bd457610bd3610828565b5b610be08582860161093b565b925050602083013567ffffffffffffffff811115610c0157610c00610828565b5b610c0d8582860161093b565b9150509250929050565b5f805f60608486031215610c2e57610c2d610824565b5b5f84013567ffffffffffffffff811115610c4b57610c4a610828565b5b610c578682870161093b565b935050602084013567ffffffffffffffff811115610c7857610c77610828565b5b610c848682870161093b565b925050604084013567ffffffffffffffff811115610ca557610ca4610828565b5b610cb18682870161093b565b9150509250925092565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610ce482610cbb565b9050919050565b610cf481610cda565b82525050565b5f602082019050610d0d5f830184610ceb565b92915050565b5f82825260208201905092915050565b7f4b65797320616e642076616c756573206172726179206c656e677468206d75735f8201527f74206d6174636800000000000000000000000000000000000000000000000000602082015250565b5f610d7d602783610d13565b9150610d8882610d23565b604082019050919050565b5f6020820190508181035f830152610daa81610d71565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f81519050919050565b5f610df282610dde565b610dfc8185610d13565b9350610e0c818560208601610b3b565b610e1581610834565b840191505092915050565b5f6060820190508181035f830152610e388186610de8565b90508181036020830152610e4c8185610de8565b90508181036040830152610e608184610de8565b9050949350505050565b5f81905092915050565b5f610e7e82610b21565b610e888185610e6a565b9350610e98818560208601610b3b565b80840191505092915050565b5f610eaf8284610e74565b915081905092915050565b7f4572726f722063616c6c696e67207365727669636520636f6e747261637420665f8201527f756e6374696f6e00000000000000000000000000000000000000000000000000602082015250565b5f610f14602783610d13565b9150610f1f82610eba565b604082019050919050565b5f6020820190508181035f830152610f4181610f08565b9050919050565b5f81905092915050565b5f610f5c82610dde565b610f668185610f48565b9350610f76818560208601610b3b565b80840191505092915050565b5f610f8d8284610f52565b915081905092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f82825260208201905092915050565b5f610fdb82610dde565b610fe58185610fc1565b9350610ff5818560208601610b3b565b610ffe81610834565b840191505092915050565b5f6110148383610fd1565b905092915050565b5f602082019050919050565b5f61103282610f98565b61103c8185610fa2565b93508360208202850161104e85610fb2565b805f5b85811015611089578484038952815161106a8582611009565b94506110758361101c565b925060208a01995050600181019050611051565b50829750879550505050505092915050565b5f6040820190508181035f8301526110b38185611028565b905081810360208301526110c78184611028565b90509392505050565b5f6040820190508181035f8301526110e88185610de8565b905081810360208301526110fc8184610de8565b9050939250505056fea2646970667358221220867764931678f59c280a74adf5efd3d448b8608e3aacb40a6fd8f66edcd34da964736f6c634300081a0033"
    # Replace with actual bytecode

    tx = iroha.transaction(
        [iroha.command("CallEngine", caller=ADMIN_ACCOUNT_ID, input=bytecode)]
    )
    IrohaCrypto.sign_transaction(tx, ADMIN_PRIVATE_KEY)
    net.send_tx(tx)
    hex_hash = binascii.hexlify(IrohaCrypto.hash(tx)).decode()
    for status in net.tx_status_stream(tx):
        print(status)
    return hex_hash

@integration_helpers.trace
def set_account_details(address, account):
    keys = ["CID1", "CID2", "CID3", "CID4", "CID5", "CID6", "CID7", "CID8", "CID9", "CID10"]
    values = [
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW1",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW2",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW3",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW4",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW5",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW6",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW7",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW8",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW9",
        "QmW2HkQ1A4Hmq1H2NdC3g9kuTjVpbxTAcNev4VbyRcKbuW10"
    ]

    params = integration_helpers.get_first_four_bytes_of_keccak(
        b"setAccountDetails(string,string[],string[])"
    )
    no_of_param = 3
    for x in range(no_of_param):
        params = params + integration_helpers.left_padded_address_of_param(
            x, no_of_param
        )
    params = params + integration_helpers.argument_encoding(account['account_id'])  # source account id
    params = params + integration_helpers.argument_encoding(keys)  # keys
    params = params + integration_helpers.argument_encoding(values)  # values
    tx = iroha.transaction(
        [
            iroha.command(
                "CallEngine", caller=ADMIN_ACCOUNT_ID, callee=address, input=params
            )
        ]
    )
    IrohaCrypto.sign_transaction(tx, ADMIN_PRIVATE_KEY)
    response = net.send_tx(tx)
    print(response)
    for status in net.tx_status_stream(tx):
        print(status)
    hex_hash = binascii.hexlify(IrohaCrypto.hash(tx)).decode()
    return hex_hash

@integration_helpers.trace
def set_account_quorum(address):
    params = integration_helpers.get_first_four_bytes_of_keccak(
        b"setAccountQuorum(string,string)"
    )
    no_of_param = 2
    for x in range(no_of_param):
        params = params + integration_helpers.left_padded_address_of_param(
            x, no_of_param
        )
    params = params + integration_helpers.argument_encoding(
        ADMIN_ACCOUNT_ID
    )  # source account id
    params = params + integration_helpers.argument_encoding("2")  # new quorum
    tx = iroha.transaction(
        [
            iroha.command(
                "CallEngine", caller=ADMIN_ACCOUNT_ID, callee=address, input=params
            )
        ]
    )
    IrohaCrypto.sign_transaction(tx, ADMIN_PRIVATE_KEY)
    response = net.send_tx(tx)
    print(response)
    for status in net.tx_status_stream(tx):
        print(status)
    hex_hash = binascii.hexlify(IrohaCrypto.hash(tx)).decode()
    return hex_hash

@integration_helpers.trace
def get_account_details(address):
    params = integration_helpers.get_first_four_bytes_of_keccak(b"getAccountDetail()")
    no_of_param = 0
    tx = iroha.transaction(
        [
            iroha.command(
                "CallEngine", caller=ADMIN_ACCOUNT_ID, callee=address, input=params
            )
        ]
    )
    IrohaCrypto.sign_transaction(tx, ADMIN_PRIVATE_KEY)
    response = net.send_tx(tx)
    for status in net.tx_status_stream(tx):
        print(status)
    hex_hash = binascii.hexlify(IrohaCrypto.hash(tx)).decode()
    return hex_hash

# Path to the CSV file
csv_file_path = 'accounts.csv'

# Read accounts from CSV
accounts = read_accounts_from_csv(csv_file_path)

# Use the first account for the example
account = accounts[0]

hash = create_contract()
print(f"Contract creation hash: {hash}")
address = integration_helpers.get_engine_receipts_address(hash)
if not address:
    print("Failed to get contract address. Exiting.")
    sys.exit(1)

hash = get_account_details(address)
integration_helpers.get_engine_receipts_result(hash)
hash = set_account_details(address, account)
hash = get_account_details(address)
integration_helpers.get_engine_receipts_result(hash)
print("done")


#Query - GetAccountDetail
user = account
query = iroha.query('GetAccountDetail',account_id=user)
IrohaCrypto.sign_query(query, ADMIN_PRIVATE_KEY)
response = net.send_query(query)
data = response.account_detail_response
print(f'Account id = {user}, details = {data.detail}')
